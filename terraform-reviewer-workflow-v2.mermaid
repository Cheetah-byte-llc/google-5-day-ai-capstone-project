graph TB
    Start([Terraform Repository]) --> Stage1[STAGE 1: DISCOVERY - WHAT]
    
    subgraph Stage1[" "]
        direction TB
        S1A[Repository Analyzer Agent<br/>MCP: parse_terraform, get_module_structure]
        S1B[Cross-Reference Linker Agent<br/>MCP: get_dependencies]
        S1A -.parallel.-> S1B
        S1A --> Context1[Shared Context:<br/>• Module inventory<br/>• File structure<br/>• Dependencies<br/>• Component catalog]
        S1B --> Context1
    end
    
    Context1 --> Stage2a[STAGE 2a: INITIAL DOCS - WHAT/WHY/HOW]
    
    subgraph Stage2a[" "]
        direction TB
        S2A[Documentation Generator Agent<br/>Creates comprehensive docs]
        S2A --> InitDocs[Initial Documentation Draft]
    end
    
    InitDocs --> Stage2b[STAGE 2b: REFINEMENT - WHAT/WHY]
    
    subgraph Stage2b[" "]
        direction TB
        S2B1[Technical Accuracy<br/>Reviewer Agent<br/>WHAT<br/>MCP: validate syntax]
        S2B2[Completeness<br/>Checker Agent<br/>WHAT<br/>Verifies coverage]
        S2B3[Clarity Enhancer<br/>Agent<br/>WHY<br/>Improves readability]
        
        S2B1 -.parallel.-> S2B2
        S2B2 -.parallel.-> S2B3
        
        S2B1 --> QualityCheck{Quality Score<br/>>= 8/10?}
        S2B2 --> QualityCheck
        S2B3 --> QualityCheck
        
        QualityCheck -->|No, iterate<br/>max 3 times| S2B1
        QualityCheck -->|Yes| PolishedDocs[Polished Documentation]
    end
    
    PolishedDocs --> Stage3[STAGE 3: GUIDANCE - HOW]
    Context1 --> Stage3
    
    subgraph Stage3[" "]
        direction TB
        S3A[Usage/Examples Agent<br/>HOW<br/>MCP: create_workspace,<br/>terraform_validate]
        S3B[Best Practices Critic Agent<br/>HOW<br/>MCP: run_tflint,<br/>run_terrascan, run_checkov]
        
        S3A -.parallel.-> S3B
        
        S3A --> UsageOut[Usage Examples &<br/>Configuration Patterns<br/>Self-validated]
        S3B --> CriticOut[Critique Report &<br/>Recommendations<br/>Tool-backed findings]
    end
    
    UsageOut --> Stage4[STAGE 4: AGGREGATION]
    CriticOut --> Stage4
    PolishedDocs --> Stage4
    Context1 --> Stage4
    
    subgraph Stage4[" "]
        direction TB
        S4[Orchestrator Agent<br/>Compiles all outputs]
        S4 --> CompletePackage[Complete Package:<br/>• Documentation<br/>• Usage Examples<br/>• Critique & Recommendations]
    end
    
    CompletePackage --> Stage5[STAGE 5: AGENTIC EVALUATION ⭐]
    Context1 --> Stage5
    Start --> Stage5
    
    subgraph Stage5[" "]
        direction TB
        S5[Evaluation Agent + MCP Server<br/>Autonomous validation]
        
        S5 --> EvalProcess[Evaluation Process]
        
        EvalProcess --> E1[1. Example Validation<br/>• Create workspaces<br/>• terraform init/validate/plan<br/>• Analyze results]
        
        EvalProcess --> E2[2. Documentation Accuracy<br/>• Parse actual code<br/>• Compare with docs<br/>• Find discrepancies]
        
        EvalProcess --> E3[3. Critique Validation<br/>• Run tflint/terrascan/checkov<br/>• Verify findings<br/>• Check coverage]
        
        EvalProcess --> E4[4. Quality Assessment<br/>• Formatting checks<br/>• Security scans<br/>• Compliance verification]
        
        E1 --> EvalResults[Evaluation Results]
        E2 --> EvalResults
        E3 --> EvalResults
        E4 --> EvalResults
    end
    
    EvalResults --> SelfCorrect{Self-Correction<br/>Needed?}
    
    SelfCorrect -->|Example pass < 90%| CorrectUsage[Trigger Usage Agent<br/>Regenerate failed examples]
    SelfCorrect -->|Doc accuracy < 95%| CorrectDocs[Trigger Stage 2b<br/>Refine documentation]
    SelfCorrect -->|Critique accuracy < 90%| CorrectCritic[Trigger Critic Agent<br/>Re-analyze findings]
    
    CorrectUsage --> IterCheck{Iterations<br/>< 2?}
    CorrectDocs --> IterCheck
    CorrectCritic --> IterCheck
    
    IterCheck -->|Yes| Stage3
    IterCheck -->|No| FinalReport[Final Report<br/>with warnings]
    
    SelfCorrect -->|All metrics pass| FinalReport[Final Evaluation Report:<br/>• Validation results<br/>• Accuracy metrics<br/>• Quality scores<br/>• Confidence ratings]
    
    FinalReport --> Interactive[STAGE 6: INTERACTIVE SESSION]
    
    subgraph Interactive[" "]
        direction TB
        I1[User Q&A Interface]
        I1 --> I2[Orchestrator maintains<br/>full context]
        I2 -.follow-up queries.-> I2
        I2 --> I3[Context-aware responses<br/>Drill-down capabilities]
    end
    
    Interactive --> End([Complete])
    
    classDef whatAgent fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef whyAgent fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef howAgent fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef overlapAgent fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef metaAgent fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef context fill:#fff9c4,stroke:#f9a825,stroke-width:2px
    classDef stage fill:#fafafa,stroke:#616161,stroke-width:3px
    classDef evaluation fill:#e1f5fe,stroke:#0277bd,stroke-width:3px
    classDef correction fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    
    class S1A,S1B,S2B1,S2B2 whatAgent
    class S2B3 whyAgent
    class S3A,S3B howAgent
    class S2A overlapAgent
    class S4,S5,I1,I2,I3 metaAgent
    class Context1,InitDocs,PolishedDocs,UsageOut,CriticOut,CompletePackage,FinalReport context
    class Stage1,Stage2a,Stage2b,Stage3,Stage4,Interactive stage
    class Stage5,EvalProcess,E1,E2,E3,E4,EvalResults evaluation
    class CorrectUsage,CorrectDocs,CorrectCritic,IterCheck correction
